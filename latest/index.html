<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Andrey Antukh, &lt;niwi@niwi.be&gt;">
<title>Catacumba - Web toolkit for Clojure.</title>
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f0f0f0; }
.listingblock .pygments .tok-c { color: #60a0b0; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #007020; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #60a0b0; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #007020 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #60a0b0; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #60a0b0; background-color: #fff0f0 } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #007020; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #007020; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #007020; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #007020 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #007020; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #902000 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #40a070 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #4070a0 } /* Literal.String */
.listingblock .pygments .tok-na { color: #4070a0 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #007020 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0e84b5; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #60add5 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #555555; font-weight: bold } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #d55537; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #007020 } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #06287e } /* Name.Function */
.listingblock .pygments .tok-nl { color: #002070; font-weight: bold } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #062873; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #bb60d5 } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #007020; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #40a070 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #40a070 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #40a070 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #40a070 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #40a070 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #4070a0 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #4070a0 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #4070a0; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #4070a0 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #4070a0; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #4070a0 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #70a0d0; font-style: italic } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #c65d09 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #235388 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #4070a0 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #517918 } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #007020 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #bb60d5 } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #bb60d5 } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #bb60d5 } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #40a070 } /* Literal.Number.Integer.Long */
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic|Liberation+Mono:400|Roboto+Slab:400,700"/>
<link rel="stylesheet" href="https://www.niwi.nz/_assets/asciidoctor-styles/simple-red-titles/stylesheet.css"/>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Catacumba - Web toolkit for Clojure.</h1>
<div class="details">
<span id="author" class="author">Andrey Antukh, &lt;niwi@niwi.be&gt;</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#rationale">Rationale</a></li>
<li><a href="#goals">Goals</a></li>
<li><a href="#project-maturity">Project Maturity</a></li>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#install">Install</a></li>
</ul>
</li>
<li><a href="#quickstart">Quick Start</a>
<ul class="sectlevel2">
<li><a href="#first-handler">First handler</a></li>
<li><a href="#running-the-server">Running the server</a></li>
<li><a href="#complete-example">Complete example</a></li>
</ul>
</li>
<li><a href="#user-guide">User Guide</a>
<ul class="sectlevel2">
<li><a href="#handlers">Handlers</a></li>
<li><a href="#routing">Routing</a></li>
<li><a href="#context">Context</a></li>
<li><a href="#asynchronous-handlers">Asynchronous Handlers</a></li>
<li><a href="#websockets">WebSockets</a></li>
<li><a href="#server-sent-events">Server-Sent Events</a></li>
<li><a href="#ring-compatibility">Ring compatibility</a></li>
</ul>
</li>
<li><a href="#builtin-handlers">Builtin Handlers</a>
<ul class="sectlevel2">
<li><a href="#body-parsing">Body parsing</a></li>
<li><a href="#auth">Auth</a></li>
<li><a href="#sessions">Sessions</a></li>
<li><a href="#context-as-request">Context as Request</a></li>
<li><a href="#security">Security</a></li>
</ul>
</li>
<li><a href="#advanced-topics">Advanced topics</a>
<ul class="sectlevel2">
<li><a href="#modular-components">Modular components</a></li>
<li><a href="#launching-the-server">Launching the server</a></li>
</ul>
</li>
<li><a href="#examples">Examples</a>
<ul class="sectlevel2">
<li><a href="#website-example">Website and Auth</a></li>
<li><a href="#single-file-example">Single file web app</a></li>
<li><a href="#sse-component-example">Multiuser chat with SSE</a></li>
<li><a href="#debugging-with-prone">Debugging with prone</a></li>
<li><a href="#instrumentation">Instrumentation</a></li>
</ul>
</li>
<li><a href="#faq">FAQ</a>
<ul class="sectlevel2">
<li><a href="#difference-with-aleph">Differences with aleph</a></li>
</ul>
</li>
<li><a href="#developers-guide">Developers Guide</a>
<ul class="sectlevel2">
<li><a href="#philosophy">Philosophy</a></li>
<li><a href="#contributing">Contributing</a></li>
<li><a href="#source-code">Source Code</a></li>
<li><a href="#run-tests">Run tests</a></li>
<li><a href="#license">License</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="introduction"><a class="link" href="#introduction">Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Catacumba</em> is an asynchronous and non-blocking web toolkit for Clojure built on top of
ratpack and netty. Is highly inspired by ratpack handlers approach with a little ideas from the
well known ring.</p>
</div>
<div class="sect2">
<h3 id="rationale"><a class="link" href="#rationale">Rationale</a></h3>
<div class="paragraph">
<p>I start writting this library as a research project to provide a simple an non obstructive
(a la ring) way to build asynchronous and non-blocking web services.</p>
</div>
<div class="paragraph">
<p>In the Clojure ecosystem there are several solutions for that purpose: Pedestal, Aleph, and Jet.
All them are good Clojure libraries/frameworks but none of them satisfies me for different reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The pedestal approach is very opinionated and too much high level and I prefer something simple,
lightweight and maybe less opinionated.</p>
</li>
<li>
<p>Aleph, seems like a great library but lacks good, readable, user friendly documentation and
its generic approach (not only http) does not help much. If you want read more about differences with
aleph, see <a href="#difference-with-aleph">this</a> faq entry.</p>
</li>
<li>
<p>Jet is a asynchronous ring addapter for Jetty 9. It is really great library that I have used in
some projects, and fits very well on my idea of web toolkit but it has two drawbacks, it is build
as ring adapter having all the good and all the bad of ring and it is using Jetty (Jetty is a
servlet server that comes with optional async support, it isn&#8217;t asynchronous from the ground up).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="goals"><a class="link" href="#goals">Goals</a></h3>
<div class="paragraph">
<p>Here a incomplete list of things that <em>catacumba</em> aims to achieve:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Have a flexible and extensible way to setup different kind of handlers</p>
</li>
<li>
<p>Provide a simple and lightweight approach for definining asynchronous web services with support for
different abstractions, such as promises, futures, core.async, manifold, reactive-streams, &#8230;&#8203;</p>
</li>
<li>
<p>Build almost everything up on abstractions for simple and easy extensibility.</p>
</li>
<li>
<p>Provide a built-in, data-based routing.</p>
</li>
<li>
<p>To be flexible and not very opinionated.</p>
</li>
<li>
<p>Have backpressure support out of the box.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>Catacumba</em> goals are not:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To be a fully integrated full stack solution like immutant or pedestal.</p>
</li>
<li>
<p>To provide an opinionated way to structure your "bussines logic"</p>
</li>
<li>
<p>To provide all possible features that you might need.</p>
</li>
<li>
<p>To be a low level, ring based library.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="project-maturity"><a class="link" href="#project-maturity">Project Maturity</a></h3>
<div class="paragraph">
<p>Since <em>catacumba</em> is a young project there can be some API breakage.</p>
</div>
</div>
<div class="sect2">
<h3 id="requirements"><a class="link" href="#requirements">Requirements</a></h3>
<div class="paragraph">
<p><em>Catacumba</em> is only runs with <strong>JDK8</strong> and <strong>Clojure 1.7+</strong> (due to extensive use of transducers
and jdk8 concurrency primitives).</p>
</div>
</div>
<div class="sect2">
<h3 id="install"><a class="link" href="#install">Install</a></h3>
<div class="paragraph">
<p>This section covers the <em>catacumba</em> library installing process and its requirements.</p>
</div>
<div class="paragraph">
<p><strong>Leiningen</strong></p>
</div>
<div class="paragraph">
<p>The simplest way to use <em>catacumba</em> in a clojure project, is by including it in the dependency
vector on your <strong><em>project.clj</em></strong> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">[</span><span class="tok-nv">funcool/catacumba</span> <span class="tok-s">&quot;0.2.0&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Gradle</strong></p>
</div>
<div class="paragraph">
<p>If you are using gradle, this is a dependency line for gradle dsl:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">compile</span> <span class="tok-s2">&quot;funcool:catacumba:0.2.0&quot;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="quickstart"><a class="link" href="#quickstart">Quick Start</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section intends to explain how to get <em>catacumba</em> up and running.</p>
</div>
<div class="sect2">
<h3 id="first-handler"><a class="link" href="#first-handler">First handler</a></h3>
<div class="paragraph">
<p>The handler consists of a function that accepts a "context" as first parameter and
returns something renderable. Let see an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-hello-world-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-s">&quot;Hello World&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The handler may look very familiar if you have used ring previously. The main difference
is that it receives a context object instead of a request object. Additionally it may return a string directly.</p>
</div>
<div class="paragraph">
<p>The following sections explain all related concepts and give a full introduction on how handlers work.</p>
</div>
</div>
<div class="sect2">
<h3 id="running-the-server"><a class="link" href="#running-the-server">Running the server</a></h3>
<div class="paragraph">
<p>Now having defined the simple, hello world handler, it is time to run it. To do it,
import the <code>run-server</code> function from <code>catacumba.core</code> ns and execute it with
handler as first parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">ct</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-nf">ct/run-server</span> <span class="tok-nv">my-hello-world-handler</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The <code>run-server</code> function does not block and you can execute it in a repl without
problems. It uses jvm not daemon threads for avoid shutdown the jvm.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="complete-example"><a class="link" href="#complete-example">Complete example</a></h3>
<div class="paragraph">
<p>This is what the complete source code of the example looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">ns </span><span class="tok-nv">exampleapp.core</span>
  <span class="tok-p">(</span><span class="tok-ss">:require</span> <span class="tok-p">[</span><span class="tok-nv">catacumba.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">ct</span><span class="tok-p">])</span>
  <span class="tok-p">(</span><span class="tok-ss">:gen-class</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-hello-world-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-s">&quot;Hello World&quot;</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">-main</span>
  <span class="tok-p">[</span><span class="tok-o">&amp;</span> <span class="tok-nv">args</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/run-server</span> <span class="tok-nv">my-hello-world-handler</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Catacumba</em> comes with a little collection of <a href="#examples">Examples</a> that may help
you setup your first project.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="user-guide"><a class="link" href="#user-guide">User Guide</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section intends explain all the different parts of <em>catacumba</em> and
how they are playing together.</p>
</div>
<div class="sect2">
<h3 id="handlers"><a class="link" href="#handlers">Handlers</a></h3>
<div class="paragraph">
<p>The idea of handlers is a fundamental piece of the <em>catacumba</em> library and this chapter intends
to explain everything related to default handlers.</p>
</div>
<div class="sect3">
<h4 id="what-is-a-handler"><a class="link" href="#what-is-a-handler">What is a handler?</a></h4>
<div class="paragraph">
<p>As we have seen int the "<a href="#quickstart">quickstart</a>" section, a handler mainly consists of a simple function
that acts on the handling context.</p>
</div>
<div class="paragraph">
<p>Do not worry about the context for now, it will be explained in later sections. The only thing that you
should known about it at this time, is that is the central part of the request and response
lifetime. It stores the current state of the http request and everything related.</p>
</div>
<div class="paragraph">
<p>The hello world handler has this source code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">myhandler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-s">&quot;Hello World&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
I mention the "default" word because, <em>catacumba</em> comes with different types of
handlers out of the box and allows to be extended with used defined ones.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="write-to-response"><a class="link" href="#write-to-response">Write to response</a></h4>
<div class="paragraph">
<p>As you can observe from the previous example, no status code is being provided, only the body of the response. To
send a complete response you can use a builtin response type or a ring-like hashmap:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.http</span> <span class="tok-ss">:as</span> <span class="tok-nv">http</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-s">&quot;Hello World&quot;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Following output data types are supported for a handler function:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <strong>string</strong>, will result in a response with status code 200 and "text/plain" as content type.</p>
</li>
<li>
<p>a <strong>ring style</strong> hash map.</p>
</li>
<li>
<p>a <strong>response</strong> type (very similar to ring one).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The handler&#8217;s return value is implemented using clojure protocols and its behavior can be extended
easily with user defined types.</p>
</div>
<div class="paragraph">
<p>Let see an other example, using <em>catacumba</em>'s response type with additional header:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.http</span> <span class="tok-ss">:as</span> <span class="tok-nv">http</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">myhandler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-s">&quot;&lt;p&gt;Hello World&lt;/p&gt;&quot;</span> <span class="tok-p">{</span><span class="tok-ss">:content-type</span> <span class="tok-s">&quot;text/html&quot;</span><span class="tok-p">}))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the previous examples, we have seen how the return value is handled, but behind the scenes
the context is the responsible of interactions with the request and the response. Let see the
same example but interacti directly with the context:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">myhandler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/set-status!</span> <span class="tok-nv">context</span> <span class="tok-mi">200</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/set-headers!</span> <span class="tok-nv">context</span> <span class="tok-p">{</span><span class="tok-ss">:content-type</span> <span class="tok-s">&quot;text/plain&quot;</span><span class="tok-p">})</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/send!</span> <span class="tok-nv">context</span> <span class="tok-s">&quot;hello world&quot;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The return value handling is really a helper for people coming from ring. Internally, the
context is the main protagonist in IO operations.</p>
</div>
</div>
<div class="sect3">
<h4 id="reading-the-request"><a class="link" href="#reading-the-request">Reading the request</a></h4>
<div class="paragraph">
<p>As we mentioned previously, the request can also be retrieved from the context instance. But in our case,
<em>catacumba</em> provides helpers functions to access the most essential data such as the request body, request
headers, cookies and routing tokens.</p>
</div>
<div class="paragraph">
<p>You can access to the request object using the <code>get-request</code> function. But, in almost all situations you
do not need it because the <em>catacumba</em> api is polymorphic and you can get access to almost all basic
properties from request using a context as parameter, so you don&#8217;t need to extract the request from context repeatedly.</p>
</div>
<div class="sect4">
<h5 id="body"><a class="link" href="#body">Body</a></h5>
<div class="paragraph">
<p>For access to the request body, <em>catacumba</em> exposes a <code>get-body</code> function. This function returns a
ratpack <a href="http://ratpack.io/manual/current/api/ratpack/http/TypedData.html">internal type</a> that
represents a body.</p>
</div>
<div class="paragraph">
<p>That object exposes through Java interop methods to access the content type and the raw data of the request body. For
convenience sake, it also implements the necesarry protocols of the <code>clojure.java.io</code> namespace to make it
compatible with Clojure&#8217;s native facilities for reading data.</p>
</div>
<div class="paragraph">
<p>A good demostration of this is using the clojure <code>slurp</code> function. It uses <code>clojure.java.io</code> abstractions
behind the scenes and serves as helper for reading a resource as a string:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">myechohandler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-o">^</span><span class="tok-nv">String</span> <span class="tok-nv">body</span> <span class="tok-p">(</span><span class="tok-nb">slurp </span><span class="tok-p">(</span><span class="tok-nf">ct/get-body</span> <span class="tok-nv">context</span><span class="tok-p">))]</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-nv">body</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t know the behavior of slurp, it reads the content of the provided resource as string
and return it.</p>
</div>
<div class="paragraph">
<p>Furthermore, <em>catacumba</em> offers a more flexible way to parsing body data based on the incoming
content type, but it is explained with more details in the <a href="#Body parsing section">body-parsing</a> of this document.</p>
</div>
</div>
<div class="sect4">
<h5 id="headers"><a class="link" href="#headers">Headers</a></h5>
<div class="paragraph">
<p>In order to extract headers you should use the <code>get-headers</code> function. As usual, it is a polymorphic function
and you could use it with a context instance without problems. The return value is a clojure map.</p>
</div>
<div class="paragraph">
<p>If a header has multiple values, the value will be a vector.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">ct/get-headers</span> <span class="tok-nv">context</span><span class="tok-p">)</span>
<span class="tok-c1">;; =&gt; {:content-type ...}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="cookies"><a class="link" href="#cookies">Cookies</a></h5>
<div class="paragraph">
<p>The cookies CRUD operations works very similiar to the headers one. It consists in two polymorphic
functions (<code>get-cookies</code> and <code>set-cookies!</code>) that can be used directly with context or with request
or response instances.</p>
</div>
<div class="listingblock">
<div class="title">Get cookies from request example</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">ct/get-cookies</span> <span class="tok-nv">context</span><span class="tok-p">)</span>
<span class="tok-c1">;; =&gt; {:cookiename {:value &quot;value&quot; :path &quot;/&quot; :secure false}}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Set cookies in the response</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">ct/set-cookies</span> <span class="tok-nv">context</span> <span class="tok-p">{</span><span class="tok-ss">:cookiename</span> <span class="tok-p">{</span><span class="tok-ss">:value</span> <span class="tok-s">&quot;foobar&quot;</span> <span class="tok-ss">:max-age</span> <span class="tok-mi">3600</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The cookies map is almost identical to the one that you can find in ring, and has the following possible
properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:domain</code> - restrict the cookie to a specific domain</p>
</li>
<li>
<p><code>:path</code> - restrict the cookie to a specific path</p>
</li>
<li>
<p><code>:secure</code> - restrict the cookie to HTTPS URLs if true</p>
</li>
<li>
<p><code>:http-only</code> - restrict the cookie to HTTP if true
(not accessible via e.g. JavaScript)</p>
</li>
<li>
<p><code>:max-age</code> - the number of seconds until the cookie expires</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="routing"><a class="link" href="#routing">Routing</a></h3>
<div class="paragraph">
<p>In contrast to ring, <em>catacumba</em> is a toolkit for web development and offers builtin support for
advanced routing that allows handlers chaining, partitioning, error handling, among other features.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<em>Catacumba</em> has a polymorphic and extensible way to setup handlers, and routing is one of multiple possible
implementations. Is completely optional and you can use any other routing library if you want.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="basic-syntax"><a class="link" href="#basic-syntax">Basic syntax</a></h4>
<div class="paragraph">
<p>The routes in <em>catacumba</em> are defined using clojure data structures: vectors and keywords. Let&#8217;s
see a little example of the aspect in a complete example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">routes</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;api&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;users&quot;</span> <span class="tok-nv">users-handler</span><span class="tok-p">]]]))</span>

<span class="tok-p">(</span><span class="tok-nf">ct/run-server</span> <span class="tok-nv">routes</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The order of statements is very important because the routing in <em>catacumba</em> is a simple chain or pipeline.
Each handler has the ability to delegate the request handling to the next handler in the pipeline.</p>
</div>
<div class="paragraph">
<p>This is a complete list of route directives that you can use a part of <code>:get</code>:  <code>:any</code> (matches all
routes, often used for add chain handlers), <code>:post</code>, <code>:put</code>, <code>:patch</code> and <code>:delete</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="dispatch-by-method"><a class="link" href="#dispatch-by-method">Dispatch by method</a></h4>
<div class="paragraph">
<p>In some circumstances you may want have different handlers depending on the HTTP method used
for one concrete endpoint. For this purpose there is the <code>:by-method</code> route directive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;api&quot;</span>
            <span class="tok-p">[</span><span class="tok-ss">:by-method</span> <span class="tok-s">&quot;users&quot;</span>
             <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">list-users-handler</span><span class="tok-p">]</span>
             <span class="tok-p">[</span><span class="tok-ss">:post</span> <span class="tok-nv">create-users-handler</span><span class="tok-p">]]])</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="routing-params"><a class="link" href="#routing-params">Routing params</a></h4>
<div class="paragraph">
<p>The <em>catacumba</em>'s routing also allows to capture URL values encoded in the URL or as URL parameters using special symbols.
For example, the path string "foo/:val" will match paths such as "foo/bar", "foo/123".  The matched parameters
are automatically populated to the context under the <code>:route-params</code> keys.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">article-detail</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">id</span> <span class="tok-p">(</span><span class="tok-nf">get-in</span> <span class="tok-nv">context</span> <span class="tok-p">[</span><span class="tok-ss">:route-params</span> <span class="tok-ss">:id</span><span class="tok-p">])]</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-p">(</span><span class="tok-nb">str </span><span class="tok-s">&quot;You have requested article with id=&quot;</span> <span class="tok-nv">id</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;articles/:id&quot;</span> <span class="tok-nv">article-detail</span><span class="tok-p">]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally to the basic token for represent the url parameter, <em>catacumba</em> also allows use of
regular expressions for delimit the input or mark a url token optional.</p>
</div>
<div class="paragraph">
<p>See the following table for all supported URL tokens:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Supported url matching tokens</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Path Type</th>
<th class="tableblock halign-left valign-top">Syntax</th>
<th class="tableblock halign-left valign-top">Route example</th>
<th class="tableblock halign-left valign-top">Matching url example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Literal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[:get "foo" handler]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/foo</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mandatory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:«token-name»</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[:get "foo/:param" handler]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/foo/bar</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:«token-name»?</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[:get "foo/:param?" handler]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/foo</code> and <code>/foo/bar</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mandatory &amp; Regex</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:«token-name»:«regex»</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[:get "foo/:id:\d+" handler]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/foo/2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional &amp; Regex</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:«token-name»?:«regex»</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[:get "foo/:id?:\d+" handler]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/foo/2</code> and <code>/foo</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="routing-chain"><a class="link" href="#routing-chain">Routing chain</a></h4>
<div class="paragraph">
<p>The chaining of handlers can be done in different ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>inline</strong>: providing more that one handler for concrete http method.</p>
</li>
<li>
<p><strong>multiple route</strong>: providing a "match all" handlers at the start of prefix.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The inline handlers chaining has this aspect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;users&quot;</span> <span class="tok-nv">permission-check-handler</span> <span class="tok-nv">get-users-handler</span><span class="tok-p">]])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, you can setup "catch all" handlers at the start and use them as interceptors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">routes</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;api&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-nv">authentication-handler</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;users&quot;</span> <span class="tok-nv">users-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For better understanding how the handlers chain delegation works, see the <strong>Context</strong> chapter.</p>
</div>
</div>
<div class="sect3">
<h4 id="error-handling"><a class="link" href="#error-handling">Error handling</a></h4>
<div class="paragraph">
<p>The <em>catacumba</em> router chain allows setup user defined error handling functions. Do it, is very
simple, just add an other route entry with <code>:error</code> route directive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">routes</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:error</span> <span class="tok-nv">my-error-handler</span><span class="tok-p">]</span>
              <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;users&quot;</span> <span class="tok-nv">users-handler</span><span class="tok-p">]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With previous code we have set a global (for all handlers in a route chain) error handler. But
there also possible set different error handlers for different prefixes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">routes</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;api&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:error</span> <span class="tok-nv">my-error-handler-for-this-prefix</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-nv">authentication-handler</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;users&quot;</span> <span class="tok-nv">users-handler</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:put</span> <span class="tok-s">&quot;users&quot;</span> <span class="tok-nv">check-permissions-handler</span> <span class="tok-nv">update-users-hander</span><span class="tok-p">]]</span>
              <span class="tok-p">[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;admin&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:error</span> <span class="tok-nv">my-error-handler-for-this-other-prefix</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;dashboard&quot;</span> <span class="tok-nv">my-dashboard-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The error handler aspect is very similar to standard http handler, the difference is that it receives
additional parameter the throwable instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-error-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span> <span class="tok-nv">error</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">http/internal-server-error</span> <span class="tok-p">(</span><span class="tok-nf">.getMessage</span> <span class="tok-nv">error</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="context"><a class="link" href="#context">Context</a></h3>
<div class="paragraph">
<p>An other core part of the <em>catacumba</em> is the <strong>Context</strong>.</p>
</div>
<div class="paragraph">
<p>The context in catacumba as in ratpack has this responsabilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provide direct access to the request and response objects.</p>
</li>
<li>
<p>Access to the contextual objects (called registry).</p>
</li>
<li>
<p>Flow control in handler chaining.</p>
</li>
<li>
<p>Convenience helpers for common handlers operation.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="handlers-delegation"><a class="link" href="#handlers-delegation">Handlers delegation</a></h4>
<div class="paragraph">
<p>In <em>catacumba</em>, the request is handled using a chain of handlers. And one concrete handler can decide
delegate tha work to the next matching handler in the chain. Probably, you have seen the different ways of chaining handlers in the router section, in this section we will see how we can delegate the request
handling to the next matching handler.</p>
</div>
<div class="paragraph">
<p>The delegation action can be done with <code>delegate</code> multiarity function. Let see a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">handler1</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">do-something</span> <span class="tok-nv">context</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/delegate</span> <span class="tok-nv">context</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">handler2</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-s">&quot;hello world&quot;</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">router</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;foo&quot;</span> <span class="tok-nv">handler1</span> <span class="tok-nv">handler2</span><span class="tok-p">]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, when request arrives to handler1, which delegates the execution to the next
handler in the chain. It do not know about next handler, it just delegates to the routing chain
to find a next handler or raise corresponding error.</p>
</div>
<div class="paragraph">
<p>Additionally to the simple handlers delegation, <em>catacumba</em> offers a simple way to pass context data
to the next handlers. It can be done passing additional parameter to the <code>delegate</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">handler1</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">do-something</span> <span class="tok-nv">context</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/delegate</span> <span class="tok-nv">context</span> <span class="tok-p">{</span><span class="tok-ss">:message</span> <span class="tok-s">&quot;foobar&quot;</span><span class="tok-p">}))</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">handler2</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">message</span> <span class="tok-p">(</span><span class="tok-ss">:message</span> <span class="tok-nv">context</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-nv">message</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example the second handler prints the message found in the context.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="asynchronous-handlers"><a class="link" href="#asynchronous-handlers">Asynchronous Handlers</a></h3>
<div class="paragraph">
<p>Asynchronous handlers are handlers that return a value in asyncrhonous way using one of the
supported abstractions, such as core.async, reactve-streams and much others (explained below).</p>
</div>
<div class="sect3">
<h4 id="channels"><a class="link" href="#channels">Channels</a></h4>
<div class="paragraph">
<p>The <code>core.async</code> channels is one of the supported abstractions that comes with <em>catacumba</em> out
of the box. It consist in a handler that returns a body as a channel or response as a channel.</p>
</div>
<div class="paragraph">
<p>This is the aspect of async handler returning the channel as a body:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-async-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">ch</span> <span class="tok-p">(</span><span class="tok-nf">chan</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nf">go</span>
      <span class="tok-p">(</span><span class="tok-nb">dotimes </span><span class="tok-p">[</span><span class="tok-nv">i</span> <span class="tok-mi">10</span><span class="tok-p">]</span>
        <span class="tok-p">(</span><span class="tok-nf">&lt;!</span> <span class="tok-p">(</span><span class="tok-nf">timeout</span> <span class="tok-mi">500</span><span class="tok-p">))</span>
        <span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">ch</span> <span class="tok-p">(</span><span class="tok-nb">str </span><span class="tok-nv">i</span> <span class="tok-s">&quot;\n&quot;</span><span class="tok-p">)))</span>
      <span class="tok-p">(</span><span class="tok-nf">close!</span> <span class="tok-nv">ch</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-nv">ch</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Returning channel as a body has the advantage that you have the ability of set additional
headers and returning code. But, if you are return a channel as a response value, the default
status code will be set for you. The behavior of two approaches is the same, resultin in a chunked
encoded response to the client.</p>
</div>
<div class="paragraph">
<p>And this is the aspect of async handler returning channel as response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-async-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">go</span>
    <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">result</span> <span class="tok-p">(</span><span class="tok-nf">&lt;!</span> <span class="tok-p">(</span><span class="tok-nf">do-some-async-task</span><span class="tok-p">))]</span>
      <span class="tok-p">(</span><span class="tok-ss">:message</span> <span class="tok-nv">result</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Do not worry about how much data you can send to the client, if you are using channels in a right way
(in a go block), yo will send data to the client as fast as client can consume it. This technique is
also called backpressure, and is fully supported for chunked responses.</p>
</div>
</div>
<div class="sect3">
<h4 id="promises"><a class="link" href="#promises">Promises</a></h4>
<div class="paragraph">
<p>Promises is an other abstraction supported out of the box in <em>catacumba</em>. It comes from the
<a href="https://github.com/funcool/futura">futura library</a> and is build on top of JDK8 <em>CompletableFuture</em>.</p>
</div>
<div class="paragraph">
<p>Sometimes, yo do not need send a chunked stream to the clien, but your "bussines logic" is defined
with asynchronous friendly api using promises (or something similar). In this case, with <em>catacumba</em>
you can return a promise as a body or as a response and the data will be sent to the client when
the promise is successfully resolved.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">futura.promise</span> <span class="tok-ss">:as</span> <span class="tok-nv">p</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-async-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">promise</span> <span class="tok-p">(</span><span class="tok-nf">p/promise</span> <span class="tok-s">&quot;hello world&quot;</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-nv">promise</span> <span class="tok-p">{</span><span class="tok-ss">:content-type</span> <span class="tok-s">&quot;text/plain&quot;</span><span class="tok-p">})))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Thanks to the <strong>future</strong> library internals, we can use it with
<a href="https://github.com/funcool/cats">cats</a> <code>mlet</code> macro, that allows us structure pure async
code in a synchronous way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">futura.promise</span> <span class="tok-ss">:as</span> <span class="tok-nv">p</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">cats.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">m</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-async-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">m/mlet</span> <span class="tok-p">[</span><span class="tok-nv">a</span> <span class="tok-p">(</span><span class="tok-nf">something-that-return-promise</span> <span class="tok-nv">context</span><span class="tok-p">)</span>
           <span class="tok-nv">b</span> <span class="tok-p">(</span><span class="tok-nf">do-something-with</span> <span class="tok-nv">a</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nf">do-other-thing-with</span> <span class="tok-nv">b</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of <code>mlet</code> macro expression will be a <strong>promise</strong> with the eventually available result
from <code>(do-other-thing-with b)</code> expression.</p>
</div>
</div>
<div class="sect3">
<h4 id="futures"><a class="link" href="#futures">Futures</a></h4>
<div class="paragraph">
<p>As previously explained promises are build on top of <strong>CompletableFutures</strong> of JDK8, <em>catacumba</em> also
supports the raw usage of them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-async-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">something-that-returns-completable-future</span> <span class="tok-nv">context</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-p">{</span><span class="tok-ss">:content-type</span> <span class="tok-s">&quot;text/plain&quot;</span><span class="tok-p">})))</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="manifold"><a class="link" href="#manifold">Manifold</a></h4>
<div class="paragraph">
<p>The <a href="https://github.com/ztellman/manifold">manifold</a> library offers different kind of deferred and
stream abstractions for clojure and you can use both them as response or body of the response for send
asynchronously data to the client.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">manifold.deferred</span> <span class="tok-ss">:as</span> <span class="tok-nv">d</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-async-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">result</span> <span class="tok-p">(</span><span class="tok-nf">d/future</span> <span class="tok-p">(</span><span class="tok-nf">Thread/sleep</span> <span class="tok-mi">1000</span><span class="tok-p">)</span> <span class="tok-s">&quot;hello world&quot;</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-nv">result</span> <span class="tok-p">{</span><span class="tok-s">&quot;content-type&quot;</span> <span class="tok-s">&quot;text/plain&quot;</span><span class="tok-p">})))</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="reactive-streams"><a class="link" href="#reactive-streams">Reactive Streams</a></h4>
<div class="paragraph">
<p>This is the core of all abstractions, and support for it comes out of the box from <strong>ratpack</strong>. All
other abstractions that we have seen are always coerced to <strong>Publisher</strong> instance before send it to the
client.</p>
</div>
<div class="paragraph">
<p>Here nothing new to explain, if you have a function that return some kind of publisher, you can return
it as response or send it as body like as usual.</p>
</div>
<div class="paragraph">
<p>The adaptations and coerciones are done thanks to the
<a href="https://github.com/funcool/futura">futura library</a> that has more adaptations supported out of the
box that which are comming with <em>catacumba</em>.</p>
</div>
<div class="paragraph">
<p>Let see an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">futura.stream</span> <span class="tok-ss">:as</span> <span class="tok-nv">stream</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">cuerdas.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">str</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-async-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">pub</span> <span class="tok-p">(</span><span class="tok-nf">-&gt;&gt;</span> <span class="tok-p">(</span><span class="tok-nf">stream/publisher</span> <span class="tok-p">[</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-s">&quot; &quot;</span> <span class="tok-s">&quot;world&quot;</span><span class="tok-p">])</span>
                 <span class="tok-p">(</span><span class="tok-nf">stream/publisher</span> <span class="tok-p">(</span><span class="tok-nb">map </span><span class="tok-nv">str/upper</span><span class="tok-p">)))]</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-nv">pub</span><span class="tok-p">)))</span>

<span class="tok-c1">;; It will return a chunked response to the client with &quot;HELLO WORLD&quot; string.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Reactive streams implementation in <a href="https://github.com/funcool/futura">futura library</a> comes with
support for different kind of coercions and with clojure 1.7 <strong>transducers</strong>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="websockets"><a class="link" href="#websockets">WebSockets</a></h3>
<div class="paragraph">
<p>One of the main goals of <em>catacumba</em> is come with builtin, full featured and backpressure aware
websockets support.</p>
</div>
<div class="paragraph">
<p>You can start a websocket connection in any <em>catacumba</em> handler or route handler using <code>websocket</code>
function. It not need special handlers for treat websockets. Let see an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-websocket-echo-handler</span>
  <span class="tok-p">[{</span><span class="tok-ss">:keys</span> <span class="tok-p">[</span><span class="tok-nv">in</span> <span class="tok-nv">out</span><span class="tok-p">]}]</span>
  <span class="tok-p">(</span><span class="tok-nf">go-loop</span> <span class="tok-p">[]</span>
    <span class="tok-p">(</span><span class="tok-nb">if-let </span><span class="tok-p">[</span><span class="tok-nv">received</span> <span class="tok-p">(</span><span class="tok-nf">&lt;!</span> <span class="tok-nv">in</span><span class="tok-p">)]</span>
      <span class="tok-p">(</span><span class="tok-nf">do</span>
        <span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-nv">received</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nf">recur</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nf">close!</span> <span class="tok-nv">out</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/websocket</span> <span class="tok-nv">context</span> <span class="tok-nv">my-websocket-echo-handler</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">route</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;events&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-nv">my-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, <em>catacumba</em> offers a a way to setup websocket handler directly, without additional step
on default handler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">echo-handler</span>
  <span class="tok-s">&quot;This is my echo handler that serves as</span>
<span class="tok-s">  a websocket handler example.&quot;</span>
  <span class="tok-p">{</span><span class="tok-ss">:handler-type</span> <span class="tok-ss">:catacumba/websocket</span><span class="tok-p">}</span>
  <span class="tok-p">[{</span><span class="tok-ss">:keys</span> <span class="tok-p">[</span><span class="tok-nv">in</span> <span class="tok-nv">out</span><span class="tok-p">]}]</span>
  <span class="tok-p">(</span><span class="tok-nf">go-loop</span> <span class="tok-p">[]</span>
    <span class="tok-p">(</span><span class="tok-nb">if-let </span><span class="tok-p">[</span><span class="tok-nv">received</span> <span class="tok-p">(</span><span class="tok-nf">&lt;!</span> <span class="tok-nv">in</span><span class="tok-p">)]</span>
      <span class="tok-p">(</span><span class="tok-nf">do</span>
        <span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-nv">received</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nf">recur</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nf">close!</span> <span class="tok-nv">out</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">route</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;events&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-o">#</span><span class="tok-ss">&#39;echo-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can observe, a function has additional metadata that indicates to <em>catacumba</em> that that
function is a websocket type handler, so <em>catacumba</em> bootstraps the websocket connection for you.</p>
</div>
<div class="paragraph">
<p>Is very important pass a var reference to the router instead of the function directly, because
the metadata defined in the function is bound to the var and not to the function.</p>
</div>
<div class="paragraph">
<p>Also, you can attach metadata inline, using the <code>with-meta</code> clojure builtin function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;events&quot;</span>
             <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nb">with-meta </span><span class="tok-nv">echo-handler</span>
                     <span class="tok-p">{</span><span class="tok-ss">:handler-type</span> <span class="tok-ss">:catacumba/websocket</span><span class="tok-p">})]]])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Clojure offers a lot of flexibility for work with metadata so, you can set the handler type
in the way that you prefers.</p>
</div>
</div>
<div class="sect2">
<h3 id="server-sent-events"><a class="link" href="#server-sent-events">Server-Sent Events</a></h3>
<div class="paragraph">
<p>WebSockets are cool because they allow bi-directional comunication, but in some circumstances we only
need something unidirectional, for notify the client about some changes or any other events. For this
purpose exists <a href="https://developer.mozilla.org/en-US/docs/Server-sent_events">Server-Sent Events</a>
and <em>catacumba</em> also has support for it.</p>
</div>
<div class="paragraph">
<p>The handlers for sse not differs a lot from websockets that we have seen in previous section. The
main difference is that the reception of the data is not allowed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">time-notification</span>
  <span class="tok-s">&quot;Handler that notifies each second</span>
<span class="tok-s">  the current server time to the client.&quot;</span>
  <span class="tok-p">{</span><span class="tok-ss">:handler-type</span> <span class="tok-ss">:catacumba/sse</span><span class="tok-p">}</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span> <span class="tok-nv">out</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">go-loop</span> <span class="tok-p">[]</span>
    <span class="tok-p">(</span><span class="tok-nb">when-let </span><span class="tok-p">[</span><span class="tok-nv">_</span> <span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-p">(</span><span class="tok-nb">str </span><span class="tok-p">(</span><span class="tok-nf">java.time.Instant/now</span><span class="tok-p">)))]</span>
      <span class="tok-p">(</span><span class="tok-nf">&lt;!</span> <span class="tok-p">(</span><span class="tok-nf">timeout</span> <span class="tok-mi">1000</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nf">recur</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">route</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;events&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-o">#</span><span class="tok-ss">&#39;time-notification</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In a similar way to websockets, you can start the sse in any place, such as standard <em>catacumba</em> handler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">time-notification</span>
  <span class="tok-s">&quot;Handler that notifies each second</span>
<span class="tok-s">  the current server time to the client.&quot;</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/sse</span> <span class="tok-nv">context</span>
          <span class="tok-p">(</span><span class="tok-k">fn </span><span class="tok-p">[</span><span class="tok-nv">_</span> <span class="tok-nv">out</span><span class="tok-p">]</span>
            <span class="tok-p">(</span><span class="tok-nf">go-loop</span> <span class="tok-p">[]</span>
              <span class="tok-p">(</span><span class="tok-nb">when-let </span><span class="tok-p">[</span><span class="tok-nv">_</span> <span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-p">(</span><span class="tok-nb">str </span><span class="tok-p">(</span><span class="tok-nf">java.time.Instant/now</span><span class="tok-p">)))]</span>
                <span class="tok-p">(</span><span class="tok-nf">&lt;!</span> <span class="tok-p">(</span><span class="tok-nf">timeout</span> <span class="tok-mi">1000</span><span class="tok-p">))</span>
                <span class="tok-p">(</span><span class="tok-nf">recur</span><span class="tok-p">))))))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">route</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;events&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-nv">time-notification</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let see some examples how you can send other parameters that simple data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-c1">;; Send data</span>
<span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-s">&quot;data as string&quot;</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-p">{</span><span class="tok-ss">:data</span> <span class="tok-s">&quot;data as string&quot;</span><span class="tok-p">})</span>

<span class="tok-c1">;; Send data with event name</span>
<span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-p">{</span><span class="tok-ss">:data</span> <span class="tok-s">&quot;data as string&quot;</span> <span class="tok-ss">:event</span> <span class="tok-s">&quot;foobar&quot;</span><span class="tok-p">})</span>

<span class="tok-c1">;; Set id</span>
<span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-p">{</span><span class="tok-ss">:id</span> <span class="tok-s">&quot;2&quot;</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <em>catacumba</em>'s sse support uses core.async channels, but if you are not
happy with core.async and want use something different (such as manifold streams), you may want know
that everything in <em>catacumba</em> is implemented using abstractions and to implement your own sse type
of handler that uses manifold streams is very easy.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ring-compatibility"><a class="link" href="#ring-compatibility">Ring compatibility</a></h3>
<div class="paragraph">
<p>Although ring support is not first citizen in <em>catacumba</em>, the current design of it allows create an
handler adapter that follows the ring specification. This is a great example of extensibility of
<em>catacumba</em>.</p>
</div>
<div class="paragraph">
<p>Let see how it can be done:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">myringhandler</span>
  <span class="tok-s">&quot;My example ring handler.&quot;</span>
  <span class="tok-p">{</span><span class="tok-ss">:handler-type</span> <span class="tok-ss">:catacumba/ring</span><span class="tok-p">}</span>
  <span class="tok-p">[</span><span class="tok-nv">request</span><span class="tok-p">]</span>
  <span class="tok-p">{</span><span class="tok-ss">:status</span> <span class="tok-mi">200</span>
   <span class="tok-ss">:body</span> <span class="tok-s">&quot;hello world&quot;</span><span class="tok-p">})</span>

<span class="tok-c1">;; As standalone handler</span>
<span class="tok-p">(</span><span class="tok-nf">ct/run-server</span> <span class="tok-o">#</span><span class="tok-ss">&#39;myringhandler</span><span class="tok-p">)</span>

<span class="tok-c1">;; Or in a _catacumba_ routing chain</span>
<span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:get</span> <span class="tok-o">#</span><span class="tok-ss">&#39;myringhandler</span><span class="tok-p">]])</span>
    <span class="tok-p">(</span><span class="tok-nf">ct/run-server</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ring handlers can be set as standalone handlers (mainly for use them as compojure and all related
middlewares) or in a <em>catacumba</em>'s routing chain.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="builtin-handlers"><a class="link" href="#builtin-handlers">Builtin Handlers</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section will cover different kind of builtin additional handlers for make the experience of
using <em>catacumba</em> more pleasant.</p>
</div>
<div class="sect2">
<h3 id="body-parsing"><a class="link" href="#body-parsing">Body parsing</a></h3>
<div class="paragraph">
<p><em>Catacumba</em> comes with builtin support for conditional body parsing depengin on the incoming
content type. It consists in a route chain that adds the <code>:body</code> entry in the context with the
parsed data or <code>nil</code> in case of incoming content type does not has attached parser implementation.</p>
</div>
<div class="paragraph">
<p>For use it, it is simple as prepend the <code>body-params</code> handler to your route chain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers</span> <span class="tok-ss">:as</span> <span class="tok-nv">hs</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">example-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">body</span> <span class="tok-p">(</span><span class="tok-ss">:body</span> <span class="tok-nv">context</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nb">println </span><span class="tok-s">&quot;Received body:&quot;</span> <span class="tok-nv">body</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">http/no-content</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">hs/body-params</span><span class="tok-p">)]</span>
              <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-nv">example-handler</span><span class="tok-p">]]))</span>

<span class="tok-c1">;; ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the <code>application/x-www-form-urlencoded</code>, <code>multipart/form-data</code> and
<code>application/json</code> parsers are comes out of the box.
The <a href="https://github.com/dakrone/cheshire">cheshire</a> json parser is used
for parse body with the <code>application/json</code> content type.</p>
</div>
<div class="paragraph">
<p>The body parsing is a open system, implemented using clojure polymorphism facilites
such as multimethods. If you want add additional parser, is as simple how add
implmenetation to the <code>parse</code> multimethod with your content-type as dispatch tag.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers.parsing</span> <span class="tok-ss">:as</span> <span class="tok-nv">parsing</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nb">import </span><span class="tok-ss">&#39;ratpack.http.TypedData</span>
        <span class="tok-ss">&#39;ratpack.handling.Context</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-kd">defmethod </span><span class="tok-nv">parsing/parse</span> <span class="tok-ss">:application/xml</span>
  <span class="tok-p">[</span><span class="tok-o">^</span><span class="tok-nv">Context</span> <span class="tok-nv">ctx</span> <span class="tok-o">^</span><span class="tok-nv">TypedData</span> <span class="tok-nv">body</span><span class="tok-p">]</span>
  <span class="tok-c1">;; your parsing logic here</span>
  <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="auth"><a class="link" href="#auth">Auth</a></h3>
<div class="paragraph">
<p>The authentication facilites in <em>catacumba</em> are built using <a href="https://github.com/funcool/buddy">buddy</a>
security library.</p>
</div>
<div class="paragraph">
<p>As <em>catacumba</em> handlers system is very flexible, you really don&#8217;t locked to use <em>buddy</em>. You can
write your own auth facilities and attach them to <em>catacumba</em> using the routing chain.</p>
</div>
<div class="paragraph">
<p>For start using auth facilities in your application, you should add the <code>auth</code> handler
to you routing chain. Let see an example using session based auth backend:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers</span> <span class="tok-ss">:as</span> <span class="tok-nv">hs</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers.auth</span> <span class="tok-ss">:as</span> <span class="tok-nv">auth</span><span class="tok-p">])</span>

<span class="tok-c1">;; Create an instance of auth backend</span>
<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">auth-backend</span>
  <span class="tok-p">(</span><span class="tok-nf">auth/session-backend</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">hs/session</span> <span class="tok-p">{</span><span class="tok-ss">:storage</span> <span class="tok-ss">:inmemory</span><span class="tok-p">})]</span>
              <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">hs/auth</span> <span class="tok-nv">auth-backend</span><span class="tok-p">)]</span>
              <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">some-handler</span><span class="tok-p">]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As we mentioned previously, behind the scenes <em>buddy</em> is used, so almost all auth backends
defined in buddy can be used with <em>catacumba</em>, such as jws and jwe backens.</p>
</div>
<div class="paragraph">
<p>It there some exceptions, such as the session auth backend, because the sessions works
slightly different in <em>catacumba</em> and the buddy session auth backend reliad in a ring
session behavior.</p>
</div>
<div class="paragraph">
<p>The buddy access rules are not supported because, the <em>catacumba</em> routing chain system
fullfills that gap. You can define concrete authorization rules and attach them directly
in a routing chain.</p>
</div>
<div class="paragraph">
<p>You can see a working example using auth facilties <a href="#website-example">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="sessions"><a class="link" href="#sessions">Sessions</a></h3>
<div class="sect3">
<h4 id="getting-started"><a class="link" href="#getting-started">Getting Started</a></h4>
<div class="paragraph">
<p>The http sessions in <em>catacumba</em> are also implemented as chain handler. So, you can add sessions
to you application just adding the handler to your routing chain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers</span> <span class="tok-ss">:as</span> <span class="tok-nv">hs</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">hs/session</span> <span class="tok-p">{</span><span class="tok-ss">:storage</span> <span class="tok-ss">:inmemory</span><span class="tok-p">})]</span>
              <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">your-handler</span><span class="tok-p">]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All handlers in the route pipeline that are going after the session handler will come with <code>:session</code>
key in the context with a "atom" like object. You just treat it as atom, so for attach some data
to the session you should use the well known <code>swap!</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">session</span> <span class="tok-p">(</span><span class="tok-ss">:session</span> <span class="tok-nv">context</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nf">swap!</span> <span class="tok-nv">session</span> <span class="tok-nb">assoc </span><span class="tok-ss">:userid</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
    <span class="tok-s">&quot;my response&quot;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can clean the session just reseting to the empty map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">reset!</span> <span class="tok-nv">session</span> <span class="tok-p">{})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One of the big advantages of using the chain routing for setup session, is that you put session
to a concrete subset of urls/resources avoiding unnecesary code execution for hendler that
does not need sessions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;admin&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">hs/session</span> <span class="tok-p">{</span><span class="tok-ss">:storage</span> <span class="tok-ss">:inmemory</span><span class="tok-p">})]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">your-handler</span><span class="tok-p">]]</span>
              <span class="tok-p">[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;api&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;users&quot;</span> <span class="tok-nv">other-handler</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">...</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="session-storages"><a class="link" href="#session-storages">Session storages</a></h4>
<div class="paragraph">
<p>Currently <em>catacumba</em> comes with one basic session storage, the <code>:inmemory</code>. But the session
storage system is plugable and is defined in terms of the following protocol:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defprotocol </span><span class="tok-nv">ISessionStorage</span>
  <span class="tok-p">(</span><span class="tok-nf">read-session</span> <span class="tok-p">[</span><span class="tok-nv">_</span> <span class="tok-nv">key</span><span class="tok-p">])</span>
  <span class="tok-p">(</span><span class="tok-nf">write-session</span> <span class="tok-p">[</span><span class="tok-nv">_</span> <span class="tok-nb">key </span><span class="tok-nv">data</span><span class="tok-p">])</span>
  <span class="tok-p">(</span><span class="tok-nf">delete-session</span> <span class="tok-p">[</span><span class="tok-nv">_</span> <span class="tok-nv">key</span><span class="tok-p">]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you known the ring based session storages, you can observe that the <em>catacumba</em> session
storage abstraction is almost identical to the ring session abstracition, so migrate or
adapt the ring session storages is really easy. The unique difference is that functions
should return a promise (from futura library).</p>
</div>
<div class="paragraph">
<p>For use a concrete session storage, just pass a instance of it as value of the <code>:storage</code>
key in a session handler constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">hs/session</span> <span class="tok-p">{</span><span class="tok-ss">:storage</span> <span class="tok-p">(</span><span class="tok-nf">my-storage-constructor</span><span class="tok-p">)})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want implement own session storage, take a look to the :inmemory builtin one.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="context-as-request"><a class="link" href="#context-as-request">Context as Request</a></h3>
<div class="paragraph">
<p>By default, the <em>catacumba</em>'s context allows you direct access to the request and response, that are
instances of classes defined in Ratpack. That classes allows you access to all related properties
such as headers, the request body, the request method, etc.</p>
</div>
<div class="paragraph">
<p>But <em>catacumba</em> at this moment offers a very limited set of helper functions for interacting with that
data: get/set headers and read the body (explained in previous sections).</p>
</div>
<div class="paragraph">
<p>For compensate this, <em>catacumba</em> comes with special chain handler that populates the context with
basic request properties such as, headers, path and method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers</span> <span class="tok-ss">:refer</span> <span class="tok-p">[</span><span class="tok-nv">basic-request</span><span class="tok-p">]])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;api/v1&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-nv">basic-request</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;foo&quot;</span> <span class="tok-nv">some-handler</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:post</span> <span class="tok-s">&quot;foo&quot;</span> <span class="tok-nv">some-save-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security"><a class="link" href="#security">Security</a></h3>
<div class="sect3">
<h4 id="cross-origin-resource-sharing"><a class="link" href="#cross-origin-resource-sharing">Cross-Origin Resource Sharing</a></h4>
<div class="paragraph">
<p>Is a mechanism that allows restricted resources (e.g. fonts, JavaScript, etc.) on a web page to be
requested from another domain outside the domain from which the resource originated.</p>
</div>
<div class="paragraph">
<p>Is often used for protect api resources to be accessed out of the domain of your web applications.</p>
</div>
<div class="paragraph">
<p><em>Catacumba</em> has builtin support for CORS, let see how you can use it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers</span> <span class="tok-ss">:refer</span> <span class="tok-p">[</span><span class="tok-nv">cors</span><span class="tok-p">]])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">cors-conf</span> <span class="tok-p">{</span><span class="tok-ss">:origin</span> <span class="tok-o">#</span><span class="tok-p">{</span><span class="tok-s">&quot;http://website.com&quot;</span><span class="tok-p">}</span>                       <span class="tok-c1">;; mandatory</span>
                <span class="tok-ss">:max-age</span> <span class="tok-mi">3600</span>                                         <span class="tok-c1">;; optional</span>
                <span class="tok-ss">:allow-headers</span> <span class="tok-p">[</span><span class="tok-s">&quot;X-Requested-With&quot;</span>, <span class="tok-s">&quot;Content-Type&quot;</span><span class="tok-p">]})</span> <span class="tok-c1">;; optional</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;api/v1&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">cors</span> <span class="tok-nv">cors-conf</span><span class="tok-p">)]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;foo&quot;</span> <span class="tok-nv">some-handler</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:post</span> <span class="tok-s">&quot;foo&quot;</span> <span class="tok-nv">some-save-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:origin</code> key can be a set of possible origins or directlly <code>"*"</code> for allow all origins.</p>
</div>
</div>
<div class="sect3">
<h4 id="content-security-policy"><a class="link" href="#content-security-policy">Content Security Policy</a></h4>
<div class="paragraph">
<p>Is a security related chain handler that appropiatelly set the <code>Content-Security-Policy</code> headers.</p>
</div>
<div class="paragraph">
<p>Content Security Policy (CSP) is an added layer of security that helps to detect and mitigate certain
types of attacks, including Cross Site Scripting (XSS) and data injection attacks. These attacks are
used for everything from data theft to site defacement or distribution of malware.</p>
</div>
<div class="paragraph">
<p>Here a simple example on how to use it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">cspconf</span> <span class="tok-p">{</span><span class="tok-ss">:default-src</span> <span class="tok-s">&quot;&#39;self&#39; *.trusted.com&quot;</span>
              <span class="tok-ss">:img-src</span> <span class="tok-s">&quot;*&quot;</span>
              <span class="tok-ss">:frame-ancestors</span> <span class="tok-s">&quot;&#39;none&#39;&quot;</span>
              <span class="tok-ss">:reflected-xss</span> <span class="tok-s">&quot;filter&quot;</span><span class="tok-p">})</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;web&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">csp-headers</span> <span class="tok-nv">cspconf</span><span class="tok-p">)]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">your-handler</span><span class="tok-p">]]])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can read more about that here: <a href="https://developer.mozilla.org/en-US/docs/Web/Security/CSP" class="bare">https://developer.mozilla.org/en-US/docs/Web/Security/CSP</a>. The
complete list of directives can be found here: <a href="https://developer.mozilla.org/en-US/docs/Web/Security/CSP/CSP_policy_directives" class="bare">https://developer.mozilla.org/en-US/docs/Web/Security/CSP/CSP_policy_directives</a></p>
</div>
<div class="paragraph">
<p>This handler supports the following directives: <code>:default-src</code>, <code>:frame-ancestors</code>, <code>:frame-src</code>,
<code>:child-src</code>, <code>:connect-src</code>, <code>:font-src</code>, <code>:form-action</code>, <code>:img-src</code>, <code>:media-src</code>,  <code>:object-src</code>,
and <code>:reflected-xss</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="frame-options"><a class="link" href="#frame-options">Frame Options</a></h4>
<div class="paragraph">
<p>This is a security related chain handler that adds <code>X-Frame-Options</code> header to the response.</p>
</div>
<div class="paragraph">
<p>The X-Frame-Options HTTP response header can be used to indicate whether or not a browser should
be allowed to render a page in a <code>&lt;frame&gt;</code>, <code>&lt;iframe&gt;</code> or <code>&lt;object&gt;</code> . Sites can use this to avoid
clickjacking attacks, by ensuring that their content is not embedded into other sites.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers</span> <span class="tok-ss">:as</span> <span class="tok-nv">handlers</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;web&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">handlers/frame-options-headers</span> <span class="tok-p">{</span><span class="tok-ss">:policy</span> <span class="tok-ss">:deny</span><span class="tok-p">})]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">your-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The possible values for the <code>:policy</code> key are: <code>:deny</code> and <code>:sameorigin</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The frame-ancestors directive from the CSP Level 2 specification
officially replaces this non-standard header.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="strict-transport-security"><a class="link" href="#strict-transport-security">Strict Transport Security</a></h4>
<div class="paragraph">
<p>This is a security related chain handler that adds the <code>Strict-Transport-Security</code> to the response.</p>
</div>
<div class="paragraph">
<p>HTTP Strict Transport Security (often abbreviated as HSTS) is a security feature that lets a web
site tell browsers that it should only be communicated with using HTTPS, instead of using HTTP.</p>
</div>
<div class="paragraph">
<p>Usage example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers</span> <span class="tok-ss">:as</span> <span class="tok-nv">handlers</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;web&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">handlers/hsts-headers</span> <span class="tok-p">{</span><span class="tok-ss">:max-age</span> <span class="tok-mi">31536000</span> <span class="tok-ss">:subdomains</span> <span class="tok-nv">true</span> <span class="tok-p">})]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">your-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can read more about that headers here: <a href="https://developer.mozilla.org/en-US/docs/Web/Security/HTTP_strict_transport_security" class="bare">https://developer.mozilla.org/en-US/docs/Web/Security/HTTP_strict_transport_security</a></p>
</div>
</div>
<div class="sect3">
<h4 id="content-type-options"><a class="link" href="#content-type-options">Content Type Options</a></h4>
<div class="paragraph">
<p>This is a security related chain handler that adds the <code>X-Content-Type-Options</code> header to the
response.It prevents resources with invalid media types being loaded as stylesheets or scripts.</p>
</div>
<div class="paragraph">
<p>This chain handler does not have any additional parameter. Let see an example on how you
can use it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers</span> <span class="tok-ss">:as</span> <span class="tok-nv">handlers</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;web&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-nv">handlers/content-type-options-headers</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">your-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>More information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://msdn.microsoft.com/en-us/library/ie/gg622941(v=vs.85).aspx" class="bare">http://msdn.microsoft.com/en-us/library/ie/gg622941(v=vs.85).aspx</a></p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/List_of_useful_HTTP_headers" class="bare">https://www.owasp.org/index.php/List_of_useful_HTTP_headers</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advanced-topics"><a class="link" href="#advanced-topics">Advanced topics</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="modular-components"><a class="link" href="#modular-components">Modular components</a></h3>
<div class="paragraph">
<p><em>Catacumba</em> is build from its ground with optional support for the <code>stuartsierra/component</code>, and
exposes a <code>catacumba-server</code> component with api for add routes and handlers from other components.</p>
</div>
<div class="paragraph">
<p>Let see a little example on how it can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">ns </span><span class="tok-nv">yourapp.system</span>
  <span class="tok-p">(</span><span class="tok-ss">:require</span> <span class="tok-p">[</span><span class="tok-nv">com.stuartsierra.component</span> <span class="tok-ss">:as</span> <span class="tok-nv">component</span><span class="tok-p">]</span>
            <span class="tok-p">[</span><span class="tok-nv">catacumba.components</span> <span class="tok-ss">:refer</span> <span class="tok-p">(</span><span class="tok-nf">catacumba-server</span> <span class="tok-nv">assoc-routes!</span><span class="tok-p">)]))</span>

<span class="tok-c1">;; Define your web application component, it will be responsable to setup</span>
<span class="tok-c1">;; the routes to the catacumba-server component of your handlers</span>

<span class="tok-p">(</span><span class="tok-kd">defrecord </span><span class="tok-nv">WebApp</span> <span class="tok-p">[</span><span class="tok-nv">server</span><span class="tok-p">]</span>
  <span class="tok-nv">component/Lifecycle</span>
  <span class="tok-p">(</span><span class="tok-nf">start</span> <span class="tok-p">[</span><span class="tok-nv">this</span><span class="tok-p">]</span>
    <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">routes</span> <span class="tok-p">[[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;foo&quot;</span> <span class="tok-nv">some-handler</span><span class="tok-p">]</span>
                  <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;bar&quot;</span> <span class="tok-nv">other-handler</span><span class="tok-p">]]</span>
      <span class="tok-p">(</span><span class="tok-nf">assoc-routes!</span> <span class="tok-nv">server</span> <span class="tok-ss">::web</span> <span class="tok-nv">routes</span><span class="tok-p">)))</span>

  <span class="tok-p">(</span><span class="tok-nf">stop</span> <span class="tok-p">[</span><span class="tok-nv">this</span><span class="tok-p">]</span>
    <span class="tok-c1">;; noop</span>
    <span class="tok-p">))</span>

<span class="tok-c1">;; Define a simple constructor for your web application component</span>
<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">webapp</span> <span class="tok-p">[]</span>
  <span class="tok-p">(</span><span class="tok-nf">-&gt;WebApp</span> <span class="tok-nv">nil</span><span class="tok-p">))</span>

<span class="tok-c1">;; Define the system with two main components: catacumba-server and webapp</span>
<span class="tok-c1">;; and explicitly specify the dependency of catacumba-server for webapp/</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">application-system</span>
  <span class="tok-s">&quot;The application system constructor.&quot;</span>
  <span class="tok-p">[]</span>
  <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">component/system-map</span>
       <span class="tok-ss">:catacumba</span> <span class="tok-p">(</span><span class="tok-nf">catacumba-server</span> <span class="tok-p">{</span><span class="tok-ss">:port</span> <span class="tok-mi">5050</span><span class="tok-p">})</span>
       <span class="tok-ss">:app</span> <span class="tok-p">(</span><span class="tok-nf">webapp</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nf">component/system-using</span>
       <span class="tok-p">{</span><span class="tok-ss">:app</span> <span class="tok-p">{</span><span class="tok-ss">:server</span> <span class="tok-ss">:catacumba</span><span class="tok-p">}})))</span>

<span class="tok-c1">;; Just define a entry point for the application.</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">-main</span>
  <span class="tok-s">&quot;The main entry point to your application.&quot;</span>
  <span class="tok-p">[</span><span class="tok-o">&amp;</span> <span class="tok-nv">args</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">component/start</span> <span class="tok-p">(</span><span class="tok-nf">application-system</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Take care, each call to the <code>assoc-routes!</code> function, the server is reloaded. In the majority of
circumstances this is completely irelevant because it is done in a application bootstrap time.</p>
</div>
<div class="paragraph">
<p>For understand it better, <em>catacumba</em> comes with an <a href="#sse-component-example">example</a> that builds a
multiuser char using "Server-Sent events" and component, so you can experiment with real code.
See the <a href="#examples">examples</a> section for it.</p>
</div>
</div>
<div class="sect2">
<h3 id="launching-the-server"><a class="link" href="#launching-the-server">Launching the server</a></h3>
<div class="paragraph">
<p>As you can see in the quick start section, the main entry point for start the server is
the <code>run-server</code> function that receives a handler and a map with options.</p>
</div>
<div class="paragraph">
<p>At this moment, it has a very little subset of options that netty and ratpack offers but is good
start point.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Supported options</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">Keyword</th>
<th class="tableblock halign-center valign-top">Default</th>
<th class="tableblock halign-center valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>:port</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>5050</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">The port to listen on.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>:threads</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(num of cores * 2)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">The number of threads for handler requests.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>:debug</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Start in development mode.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>:setup</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">nil</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">A callback for configuration step (low level ratpack access).</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>:basedir</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">nil</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">The application base directory, used mainly for resolve relative paths and assets.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>All supported options of this function, can be overwritten on jvm startup, using environment variables
or system properties. This allows customize the server out of source code and exists for convenience
for make easy customizations in deployments.</p>
</div>
<div class="paragraph">
<p>For example, you can change the default port on jvm startup using <code>CATACUMBA_PORT</code> environment variable
or <code>catacumba.port</code> system property:</p>
</div>
<div class="listingblock">
<div class="title">Example using enviroment variables</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nb">export </span><span class="tok-nv">CATACUMBA_PORT</span><span class="tok-o">=</span>8000
<span class="tok-nb">export </span><span class="tok-nv">CATACUMBA_BASEDIR</span><span class="tok-o">=</span><span class="tok-sb">`</span><span class="tok-nb">pwd</span><span class="tok-sb">`</span>
java -jar yourjarhere.jar</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example using enviroment variables</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">java -Dcatacumba.port<span class="tok-o">=</span><span class="tok-m">8000</span> -Dcatacumba.debug<span class="tok-o">=</span><span class="tok-nb">false</span> -jar yourjarhere.jar</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="examples"><a class="link" href="#examples">Examples</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="website-example"><a class="link" href="#website-example">Website and Auth</a></h3>
<div class="paragraph">
<p>This example tries to show the way to use <em>catacumba</em> in a website like projects, with authentication
and session.</p>
</div>
<div class="paragraph">
<p>You can see the example code here:
<a href="https://github.com/funcool/catacumba/tree/master/examples/website" class="bare">https://github.com/funcool/catacumba/tree/master/examples/website</a></p>
</div>
</div>
<div class="sect2">
<h3 id="single-file-example"><a class="link" href="#single-file-example">Single file web app</a></h3>
<div class="paragraph">
<p>This example tries to show hoy you can use <em>catacumba</em> for build small web applications that fits
in one file and execute them like a shell script or an executable.</p>
</div>
<div class="paragraph">
<p>This example requires <a href="http://boot-clj.com/" class="bare">http://boot-clj.com/</a></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/funcool/catacumba/tree/master/examples/single-file" class="bare">https://github.com/funcool/catacumba/tree/master/examples/single-file</a></p>
</div>
</div>
<div class="sect2">
<h3 id="sse-component-example"><a class="link" href="#sse-component-example">Multiuser chat with SSE</a></h3>
<div class="paragraph">
<p>This example tries to demostrate how can you build a simple chat using "Server-Sent Events" for
communicating events to the client and using <strong>stuartsierra/component</strong> for the modular application
architecture.</p>
</div>
<div class="paragraph">
<p>You can see the example code here:
<a href="https://github.com/funcool/catacumba/tree/master/examples/component-chat" class="bare">https://github.com/funcool/catacumba/tree/master/examples/component-chat</a></p>
</div>
</div>
<div class="sect2">
<h3 id="debugging-with-prone"><a class="link" href="#debugging-with-prone">Debugging with prone</a></h3>
<div class="paragraph">
<p><a href="https://github.com/magnars/prone">Prone</a> is really awesome middleware for ring that shows
a beautiful and human readable stack traces when a exception is raised in our application. It is not
directly compatible with <em>catacumba</em> but is relativelly easy adapt it.</p>
</div>
<div class="paragraph">
<p>You can see the example code here: <a href="https://github.com/funcool/catacumba/tree/master/examples/debugging" class="bare">https://github.com/funcool/catacumba/tree/master/examples/debugging</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Obviously, if you are using the ring type of handler, you can use prone as is, without any
additional adaptation. This example shows how it can be used with default handler type.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="instrumentation"><a class="link" href="#instrumentation">Instrumentation</a></h3>
<div class="paragraph">
<p><em>Catacumba</em> comes with the ability to instrument your application for take different kind of diagnosis,
such as performance, latency, etc. This example shows how it can be done.</p>
</div>
<div class="paragraph">
<p>You can see the example code here: <a href="https://github.com/funcool/catacumba/tree/master/examples/interceptor" class="bare">https://github.com/funcool/catacumba/tree/master/examples/interceptor</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="faq"><a class="link" href="#faq">FAQ</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="difference-with-aleph"><a class="link" href="#difference-with-aleph">Differences with aleph</a></h3>
<div class="paragraph">
<p>First of all, Aleph is one of the most robust libraries in clojure ecosystem for building asynchronous
servers. Here is an incomplete list of differences and motivations why I wrote <em>catacumba</em> instead
of using <em>aleph</em> directly in my applications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Aleph with manifold offers good abstractions for creating async servers but they are to much
low level and only provide the basic building blocks. <em>catacumba</em> intends to be a toolkit highly
focused on web development providing a good collection of facilities for that.</p>
</li>
<li>
<p>I wrote <em>catacumba</em> tp have something different to ring and <em>Aleph</em> that uses ring abstraction for
handle web requests.</p>
</li>
<li>
<p>Aleph has a good path to have an easily readable  and user friendly documentation.</p>
</li>
<li>
<p>Aleph is build on manifold streams and <em>catacumba</em> uses reactive-streams abstractions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>Catacumba</em> does not intend to be a replacement for it, it simply has different focus.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="developers-guide"><a class="link" href="#developers-guide">Developers Guide</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="philosophy"><a class="link" href="#philosophy">Philosophy</a></h3>
<div class="paragraph">
<p>Five most important rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Beautiful is better than ugly.</p>
</li>
<li>
<p>Explicit is better than implicit.</p>
</li>
<li>
<p>Simple is better than complex.</p>
</li>
<li>
<p>Complex is better than complicated.</p>
</li>
<li>
<p>Readability counts.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All contributions to <em>catacumba</em> should keep these important rules in mind.</p>
</div>
</div>
<div class="sect2">
<h3 id="contributing"><a class="link" href="#contributing">Contributing</a></h3>
<div class="paragraph">
<p><strong>catacumba</strong> unlike Clojure and other Clojure contrib libs, does not have many
restrictions for contributions. Just open a issue or pull request.</p>
</div>
</div>
<div class="sect2">
<h3 id="source-code"><a class="link" href="#source-code">Source Code</a></h3>
<div class="paragraph">
<p><em>catacumba</em> is open source and can be found on <a href="https://github.com/funcool/catacumba">github</a>.</p>
</div>
<div class="paragraph">
<p>You can clone the public repository with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text">git clone https://github.com/funcool/catacumba</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run-tests"><a class="link" href="#run-tests">Run tests</a></h3>
<div class="paragraph">
<p>For run tests just execute this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text">boot watch-tests</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="license"><a class="link" href="#license">License</a></h3>
<div class="paragraph">
<p><em>catacumba</em> is licensed under BSD (2-Clause) license:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Copyright (c) 2015 Andrey Antukh &lt;niwi@niwi.nz&gt;

All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

* Redistributions of source code must retain the above copyright notice, this
  list of conditions and the following disclaimer.

* Redistributions in binary form must reproduce the above copyright notice,
  this list of conditions and the following disclaimer in the documentation
  and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-06-08 01:11:39 CEST
</div>
</div>
</body>
</html>